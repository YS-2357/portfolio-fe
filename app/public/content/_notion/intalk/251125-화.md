---
태그: []
날짜: "2025-11-25"
이름: "25.11.25 (화)"
---

# 25.11.25 (화)


# 📅 날짜: 25.11.25 (화)


## 🧩 주요 업무


- 보험가입내역서 분석 서비스를 위한 백엔드 1차 구조 설계 및 핵심 모듈 구현

- LangGraph 기반 파이프라인(파싱→표준 검색→매칭→LLM 진단) 설계 및 매칭 노드 추가

- 보장분석 GPT 기준표(CSV) 구조 정제 및 페르소나 기반 보장 기준 설계 논리 고도화

- 보험 강사 컨설팅을 위한 질문 리스트 설계 및 40분 내 효율적 질의 구조 정리

## 🎯 목표 정리


### 장기 목표


- 표준 기준표와 고객 보험가입내역을 기반으로 정량 비교·정성 설명을 동시에 제공하는 보장분석 GPT 구축

- 보험 기준 자동화 모델(표준 CSV + 분석 엔진 + LLM 리포트)의 재사용 가능한 백엔드 레퍼런스 아키텍처 확립

### 단기 목표


- CLI 기반 보험가입내역서 분석 파이프라인의 안정적인 동작 확보

- 매칭 노드 도입을 통해 LLM 진단 범위를 표준 보장 전 항목으로 확장

- 11/28 강사 컨설팅 전까지 CSV 기준표와 질문지의 최종본 확정

## ⚙️ 진행 및 이슈


- **백엔드 구조 설계 및 구현**

- **매칭 노드 도입 및 워크플로우 개편**

- **프롬프트 및 진단 구조 개선**

- **기준표·CSV 정제 및 구조 통일**

- **개선 과제(미해결)**

## 🧠 느낀 점 및 개선


- 기준표와 코드 구조를 동시에 정비하면서, “정량 로직(비교·스코어링)”과 “정성 설명(LLM)”을 분리하는 설계가 유지보수와 확장성 측면에서 유효함을 확인

- LLM에 전달하는 입력 규모와 구조를 사전에 정제할수록 진단 범위·일관성이 향상된다는 점을 재확인

- 기준 설계와 구현을 병행할 때, CSV·스키마·프롬프트를 한 축으로 보고 인덱스 체계를 먼저 정의하는 방식이 효율적임을 인지

## 🤝 협업 및 커뮤니케이션


- 11/28 보험 강사 컨설팅을 전제로, 배경설명·핵심 질문·세부 질문·CSV 사전 검토 요청으로 구성된 질문지 초안 정리

- 강사에게는 “표준 기준 검증”과 “실무 관점 임계값 수집” 두 축을 명확히 전달할 수 있도록 구조화

- 향후 GA 대상 CSV 채우기 및 페르소나 확장 작업을 염두에 두고, 협업 시 설명이 용이한 형태로 기준표를 정제

## 📚 참고 및 학습 내용


- LangGraph 기반 멀티 노드 파이프라인 설계 패턴(파싱→검색→매칭→진단)

- 보험 보장 설계 시 페르소나(연령·소득·직업·혼인 상태)에 따른 최소/적정/과다 기준 설정 방식

- 실무 컨설팅을 통해 확보해야 할 도메인 임계값(금액 컷오프, 비중, 담보 우선순위 등)의 유형 정리

## 📈 성과 및 지표


- 보장분석 기준표(CSV) 정제본 1차 완성 및 페르소나 기반 기준 논리 프레임워크 정리

- LangGraph 파이프라인에 매칭 노드 추가 후 LLM 진단 커버리지 9개 → 32개로 확대

- CLI 기준의 분석 실행 플로우(`-init-db`, `-debug` 포함) 정리 및 문서화

- 강사 컨설팅용 질문 리스트(핵심 3개 + 세부 5~7개 + 사전 CSV 검토 요청) 구조 확정

## 🗓️ 내일 계획


- 매칭 결과 포맷 및 프롬프트를 추가 조정해 36개 전 항목 진단 달성 시도

- `_parse_ratio()` 유틸 구현 및 권장비중을 백분율 기반 출력으로 통일

- FastAPI 엔드포인트 초안 설계 및 현재 CLI 로직과의 연결 구조 검토

- 강사 컨설팅 전에 공유할 자료(기준표 요약, 페르소나 설명, 분석 예시) 최소 단위 정리 및 문서화

```json
당신은 ‘업무일지와 회고 정리 전문가’다.  
아래 사용자의 입력을 바탕으로 하루치 업무일지를 Markdown 형식으로 작성하라.  
입력이 비어 있으면 디폴트 예시 내용을 넣는다.  
결과는 실제 업무 문서에 기록 가능한 수준의 정확성·간결성을 유지하라.

---

입력 형식:
[업무 내용]
1. 코드 작업 내용:
"""
# 작업 일지 - 2025-11-25

## 목표

보험가입내역서 분석 서비스 백엔드 1차 개발

---

## 오전: 백엔드 1차 개발

### 1. 프로젝트 구조 설계

```
backend/
├── main.py                    # CLI 실행
├── app/
│   ├── config.py              # 환경변수, DEBUG 설정
│   ├── models/
│   │   └── schemas.py         # Pydantic 스키마
│   ├── services/
│   │   ├── pdf_parser.py      # PDF 파싱
│   │   ├── vectorstore.py     # 벡터스토어
│   │   └── diagnosis.py       # LLM 진단
│   └── graph/
│       ├── state.py           # LangGraph State
│       ├── nodes.py           # 노드 함수
│       └── workflow.py        # 워크플로우
```

### 2. 핵심 기능 구현

| 기능 | 파일 | 설명 |
|------|------|------|
| 환경 설정 | `config.py` | .env 로드, LangSmith 트레이싱, debug_log 유틸 |
| 스키마 정의 | `schemas.py` | 보장진단, 보장분석결과 Pydantic 모델 |
| PDF 파싱 | `pdf_parser.py` | 고객 내역서에서 실손/정액요약/정액상세 추출 |
| 벡터스토어 | `vectorstore.py` | 표준 CSV → Chroma, 메타데이터 필터 검색 |
| LLM 진단 | `diagnosis.py` | 프롬프트 + PydanticOutputParser |
| 워크플로우 | `graph/` | LangGraph 기반 파싱→검색→진단 파이프라인 |

### 3. 워크플로우 흐름 (1차)

```
[PDF 입력] → [파싱] → [표준 검색] → [LLM 진단] → [결과 출력]
```

1. **파싱**: PDF에서 고객 보장 정보 추출 (보험나이, 성별 자동 계산)
2. **검색**: 메타데이터 필터(연령대, 성별, 직업, 지역, 소득수준)로 표준 조회
3. **진단**: LLM이 고객 vs 표준 비교하여 과부족/개수/미가입 진단

### 4. 진단 출력 스키마

```python
class 보장진단(BaseModel):
    보장범위: str          # 암, 뇌혈관, 심장 등
    보장명: str            # 일반암진단
    진단결과: Literal["적정", "부족", "과다", "미가입"]
    고객금액: int | None
    표준최소: int
    표준최대: int
    권장개수_최소: int
    권장개수_최대: int
    고객개수: int
    권장비중: str          # "종신2 정기8 갱신7 비갱신3"
    코멘트: str
```

### 5. 문서화

- `README.md` - 프로젝트 소개, 빠른 시작 가이드
- `backend/README.md` - CLI 사용법, 옵션 설명
- `data/README.md` - PDF/CSV 형식, 컬럼 설명

### 6. 오전 커밋 내역

1. `feat(config)`: 환경변수 및 디버그 설정 추가
2. `feat(schemas)`: Pydantic 스키마 정의
3. `refactor(pdf_parser)`: PDF 파싱 로직 개선
4. `feat(vectorstore)`: 벡터스토어 초기화 및 검색 기능
5. `feat(diagnosis)`: LLM 진단 로직 구현
6. `feat(graph)`: LangGraph 워크플로우 구현
7. `refactor(main)`: CLI 실행 스크립트 이동
8. `chore(deps)`: 의존성 패키지 업데이트
9. `docs(readme)`: 사용법 문서 업데이트
10. `chore(gitignore)`: 벡터스토어 폴더 제외
11. `docs`: 프로젝트 및 데이터 사용법 문서화

---

## 오후: 매칭 노드 추가 및 프롬프트 개선

### 1. 문제점 발견

1차 개발 후 테스트 결과, **LLM이 36개 표준 보장 중 9개만 진단**하는 문제 발생

**원인 분석:**
- LLM에게 고객 보장 100개 + 표준 보장 36개를 한꺼번에 전달
- LLM이 데이터를 직접 비교/분석해야 하는 부담
- 중요해 보이는 일부만 선택적으로 진단

### 2. 해결 방안: 매칭 노드 추가

LLM 호출 전에 **데이터 전처리(매칭)** 단계를 추가하여 LLM의 부담을 줄임

**새로운 워크플로우:**
```
[PDF 입력] → [파싱] → [표준 검색] → [매칭] → [LLM 진단] → [결과 출력]
```

### 3. 신규/수정 파일

#### 3.1 `matching.py` (신규 생성)

고객 보장과 표준 보장을 1:1 매칭하는 로직

```python
def match_coverages(customer_docs, standard_docs) -> list[dict]:
    """
    표준 보장 기준으로 고객 보장 매칭
    - 동일 보장명의 금액 합산
    - 미가입 보장 추출
    """

def _group_customer_by_name(customer_docs) -> dict:
    """
    고객 보장을 보장명별로 그룹화
    예: {"일반암진단": {"합계": 10480, "개수": 2}, ...}
    """

def _extract_reason(std_doc) -> str:
    """표준 Document에서 판단근거 추출"""
```

**매칭 결과 구조:**
```python
{
    "보장범위": "암",
    "보장명": "일반암진단",
    "고객금액": 5000,      # None이면 미가입
    "고객개수": 2,
    "표준최소": 3000,
    "표준최대": 7000,
    "권장개수_최소": 1,
    "권장개수_최대": 3,
    "권장비중": "종신2 정기8 갱신7 비갱신3",
    "판단근거": "암 발생률 증가 추세..."
}
```

#### 3.2 `state.py` 수정

```python
class AnalysisState(TypedDict):
    # ... 기존 필드 ...
    매칭결과: list[dict]  # 신규 추가
```

#### 3.3 `nodes.py` 수정

**match_node 추가:**
```python
def match_node(state: AnalysisState) -> dict:
    """
    매칭 노드
    - 고객 보장과 표준 보장 1:1 매칭
    - 동일 보장명 금액 합산
    - 미가입 보장 추출
    """
    고객문서 = state["고객문서"]
    표준문서 = state["표준문서"]
    매칭결과 = match_coverages(고객문서, 표준문서)
    return {"매칭결과": 매칭결과}
```

**diagnose_node 수정:**
```python
def diagnose_node(state: AnalysisState) -> dict:
    """
    LLM 진단 노드
    - 매칭 결과를 기반으로 진단 (변경됨)
    """
    고객정보 = state["고객정보"]
    매칭결과 = state["매칭결과"]  # 고객문서, 표준문서 대신 매칭결과 사용
    분석결과 = run_diagnosis(고객정보, 매칭결과)
    return {"분석결과": 분석결과}
```

#### 3.4 `diagnosis.py` 수정

**프롬프트 전면 개편:**

기존: 고객보장 + 표준보장을 각각 전달
변경: 매칭결과를 구조화된 형태로 전달

**새 프롬프트 핵심:**
```
## 매칭 결과
1. [암] 일반암진단
   고객: 5000만원 (2개)
   표준: 3000~7000만원, 권장개수 1~3개
   권장비중: 종신2 정기8 갱신7 비갱신3
   판단근거: 암 발생률 증가 추세...

2. [뇌혈관] 뇌출혈진단
   고객: 미가입 (0개)
   ...
```

**코멘트 작성 규칙 추가:**

각 보장에 대해 다음 항목을 **모두** 포함하도록 명시:
- 권장 금액 범위
- 권장 개수
- 종신/정기 비중 (백분율)
- 갱신/비갱신 비중 (백분율)
- 판단근거 기반 설명

**4가지 케이스별 예시 코멘트 추가:**

1. **적정 예시:**
   > "적정합니다. 권장 금액(3,000~7,000만원) 내에 있으며, 가입 개수(2개)도 권장 범위(1~3개) 내입니다. 종신 20%, 정기 80% 비중과 갱신 70%, 비갱신 30% 비중을 권장합니다. 암 발생률 증가 추세와 평균 치료비(3,000~5,000만원)를 고려한 적정 수준입니다."

2. **부족 예시:**
   > "부족합니다. 현재 500만원으로 권장 최소 금액(2,000만원)에 미달합니다. 2,000~5,000만원으로 증액을 권장합니다..."

3. **과다 예시:**
   > "과다합니다. 현재 300만원(5개)으로 권장 최대 금액(100만원)을 초과합니다. 30~100만원, 1~2개로 조정을 권장합니다..."

4. **미가입 예시:**
   > "미가입 상태입니다. 권장 금액 2,000~5,000만원, 권장 개수 1~2개로 가입을 권장합니다..."

**함수 변경:**
```python
# 기존
def run_diagnosis(customer_info, customer_docs, standard_docs)

# 변경
def run_diagnosis(customer_info, matched_results)
```

```python
def format_matched_results(matched: list[dict]) -> str:
    """매칭 결과를 LLM 입력용 문자열로 포맷"""
```

#### 3.5 `workflow.py` 수정

**노드 연결 변경:**
```python
# 기존
workflow.add_edge("search_standard", "diagnose")

# 변경
workflow.add_edge("search_standard", "match")
workflow.add_edge("match", "diagnose")
```

**initial_state에 매칭결과 추가:**
```python
initial_state = {
    # ... 기존 필드 ...
    "매칭결과": [],  # 신규 추가
}
```

### 4. 테스트 결과

- LLM 입력: 36개 매칭결과 전달
- LLM 출력: 32개 진단 (4개 누락 - 추후 개선 필요)
- 코멘트 품질: 모든 기준(금액, 개수, 비중, 판단근거) 포함하여 상세하게 작성됨

### 5. 발견된 개선점 (미해결)

1. **LLM이 36개 중 32개만 진단** - 프롬프트 추가 튜닝 필요
2. **권장비중 출력 형식** - "종신1 정기9"보다 "종신 10% / 정기 90%" 형식이 더 직관적
   - `_parse_ratio()` 함수 추가하여 백분율 변환 필요
3. **format_matched_results()에서 권장비중 중복 출력** - 버그 수정 필요

### 6. 오후 커밋 내역

1. `feat(matching): 매칭 노드 추가 및 프롬프트 개선`
   - matching.py 신규: 고객-표준 보장 1:1 매칭 로직
   - nodes.py: match_node 추가, diagnose_node 수정
   - state.py: 매칭결과 필드 추가
   - workflow.py: 매칭 노드 연결
   - diagnosis.py: 프롬프트 전면 개편 (4가지 케이스별 예시)
   - README 업데이트: 워크플로우 및 사용법 반영

2. `chore: gitignore 및 config 수정`
   - .gitignore: vectorstore 폴더 추가
   - config.py: DEBUG 기본값 제거

---

## 저녁: 표준 CSV 검증 질문지 작성

### 1. 배경

11/28(금) 보험 강사님께 40분 컨설팅 예정.
현재 CSV 파일의 표준 보장 기준이 현업 관점에서 적절한지 검증받기 위한 질문지 작성.

### 2. 질문지 구조

#### A. 페르소나 → 판단 규칙 전반 (7개 질문)

| # | 질문 요약 |
|---|----------|
| A-1 | 고객 분류 시 보장구성에 가장 영향을 미치는 항목 우선순위 |
| A-2 | 30대 서울 남성 사무직 고소득 미혼의 주요 리스크 |
| A-3 | 페르소나 변화(미혼→기혼, 자녀, 소득)에 따른 우선순위/권장금액 변화 룰 |
| A-4 | 암·뇌·심장 진단비 권장금액 산정 기준 (소득 대비 배수) |
| A-5 | 사망보장 적정 수준 (연소득×배수, 미혼/기혼/자녀별) |
| A-6 | 갱신/비갱신 비율 기준 (나이별, 소득별 패턴) |
| A-7 | 동일 담보 분할 가입 기준 (몇 건까지, 비효율 기준) |

#### B. 보장군별 세부 판단 검증 (10개 질문)

**B-1. 암 (4개)**
- 암 항목별 필수/선택/불필요 재구분
- CSV 권장 금액 적정성 검토
- 암 보장 총액 부족/적정/과다 기준
- 항암치료비 vs 진단비 균형 비율

**B-2. 뇌혈관·심장 (2개)**
- 뇌·심장 진단비 적정 수준 (암 대비 %)
- 진단비/수술비/입원비 우선순위

**B-3. 실손·입원·통원 (2개)**
- 실손 보장 필수 여부
- 입원일당, MRI/MRA, 도수치료 등 필수/선택/불필요 구분

**B-4. 사망·후유장해·생활보장 (2개)**
- 사망보장 최소/적정/과다 기준 (소득·혼인별)
- 후유장해 항목 필수/선택/불필요 구분
- 생활특약(가족배상책임, 골프장 등) 실무 활용도

#### C. 동적 판단을 위한 임계값·규칙 수집 (3개 질문)

| # | 질문 요약 |
|---|----------|
| C-1 | 보장별 부족/과다 컷오프 (연령대·소득구간별) |
| C-2 | 갱신/비갱신, 정기/종신 강한 룰 |
| C-3 | 동일 담보 분할 가입 상황 및 최대 건수 |

### 3. 질문지 개선 사항 (Claude 제안)

1. **배경 설명 간소화** - 40분 제한이므로 3줄로 압축
2. **중복 질문 통합** - A-4, A-5, C-1 → 하나로 통합
3. **B-2 질문 추가** - 뇌출혈/뇌경색/뇌졸중, 급성심근경색/허혈성심장 세부 담보 우선순위
4. **CSV 직접 검토 요청** - 사전에 파일 전달하여 "이건 아니다" 항목 체크 요청
5. **우선순위 명시** - 핵심 질문 3개 vs 가능하면 답변 질문 구분
6. **빠진 질문 추가**
   - 실손 세대 구분 (4세대 기준? 3세대 이하 비중?)
   - 보험료 예산 기준 (월소득의 몇 %?)

### 4. 최종 질문지 구조 제안

```
# 1. 배경 (3줄)
# 2. 핵심 질문 (3개) - 반드시 답변
   - A-1: 페르소나 분류 기준 우선순위
   - A-4+5+C-1: 보장별 적정 금액 기준 (통합)
   - A-6: 갱신/비갱신 비율 기준
# 3. 세부 질문 (5~7개) - 가능하면 답변
# 4. 사전 요청: CSV 검토 부탁
```

---

## 사용 방법

```bash
cd backend

# 1. 벡터스토어 초기화 (최초 1회)
python main.py --init-db

# 2. 분석 실행
python main.py

# 3. 디버그 모드
python main.py --debug
```

---

## 다음 단계

### 코드 개선
- [ ] LLM 36개 전체 진단하도록 프롬프트 튜닝
- [ ] 권장비중 백분율 변환 함수 추가 (`_parse_ratio()`)
- [ ] format_matched_results() 중복 출력 버그 수정
- [ ] FastAPI 엔드포인트 구현
- [ ] 프론트엔드 연동

### 표준 CSV 검증
- [ ] 11/28 강사님 컨설팅 후 피드백 반영
- [ ] GA 분들에게 CSV 내용 채우기 요청
- [ ] 페르소나별 CSV 파일 확장 (현재 30대 고소득 남성만 존재)

"""
2. 개발내용:
"""
2025-11-25 업무 요약
1. 보장분석 GPT 기준표 정교화

기존 CSV 기준표를 기반으로 보장군별 권장금액·비중·개수·판단근거 구조를 완성.

판단기준 포함여부(O/△/X → 2/1/0), 종신/정기·갱신/비갱신 비율 분리, 권장개수 정제 등 전 항목 숫자화 규칙 확립.

엑셀/CSV로 전달 가능한 형태로 재구성.

2. 페르소나 기반 보장 기준 설계 논리 완성

30대·서울·남성·고소득·사무직·미혼 페르소나 기준으로
암/뇌/심장/상해/사망/실손 등 전 영역에 대해
최소·적정·과다 금액 기준, 권장 개수, 우선순위 로직 개별 작성.

종신/정기, 갱신/비갱신 비중을 정교하게 설정.

3. 강사 컨설팅용 질문 리스트 설계

강사 피드백을 40분 안에 최대로 뽑기 위한 컨설팅 구조 설계.

강사에게 보낼 배경설명(간결 버전) + 핵심질문 3개 + 세부질문 5~7개 + CSV 사전 검토 요청 구조 확정.

질문 중 중복 제거, 통합 구성(A-4/A-5/C-1), 우선순위 구분 작업 완료.

4. CSV 기준표 → 최종 정제본 생성

CSV를 엑셀에 바로 붙여넣을 수 있도록 구조 오류, 공백, delimiter, dash 수정 작업.

기준표 내

판단기준 코드 변경,

비율 분리,

결측치 보완,

전체 구조 통일
작업 완료.

5. 실무적 관점의 쟁점 검토

CSV 기준표를 실제 강사/GA 시선에서 봤을 때
기준이 흔들릴 위험 요소 검토.

“개인정보에 따른 동적 판단 기준”,
“연령·소득별 차등 로직”,
“갱신/비갱신 기준 고정 가능성” 등
실무 검증 포인트 논의 및 보완.

6. 질문지 최종 리뷰

질문지 초안 평가 → 개선 포인트 정리(배경 단순화, 우선순위 강조, 빠진 질문 추가).

실제 전달 가능 여부 검증(40분 기준).

오늘의 핵심 산출물

보장분석 기준표(CSV) 정제본

강사 컨설팅용 질문지(핵심+세부+사전요청)

페르소나 기반 보장기준 논리 프레임워크

보험 기준 자동화 모델의 주요 인덱스 체계 정리
"""

[느낀 점]
1. (업무 중 느낀 점, 개선점, 배운 점 등)

---

출력 양식:

# 📅 날짜: (예: 25.11.11 (화))

## 🧩 주요 업무
- 오늘 수행한 핵심 업무를 구체적으로 요약  
- 기술적 결과, 진행 상황, 산출물 등을 명시  

## 🎯 목표 정리
### 장기 목표
- 프로젝트의 중장기적 방향 또는 최종 지향점  
### 단기 목표
- 오늘 혹은 이번 주 달성 목표  

## ⚙️ 진행 및 이슈
- 진행 단계별 구체적 내용  
- 발생한 문제와 해결 과정  
- 미해결 과제 및 후속 조치  

## 🧠 느낀 점 및 개선
- 사용자 입력 기반으로 정리된 통찰, 개선 아이디어, 학습 내용  

## 🤝 협업 및 커뮤니케이션
- 회의, 보고, 협업 이슈, 의사소통 내용 정리  
- 논의된 결정사항 및 향후 조율 방향  

## 📚 참고 및 학습 내용
- 새로 학습하거나 참고한 기술·논문·문서  
- 업무 개선에 도움이 된 개념 또는 자료  

## 📈 성과 및 지표
- 정량적 성과(예: 정확도, 속도, 효율 등)  
- 수치가 없을 경우 주요 진척도를 서술  

## 🗓️ 내일 계획
- 다음 업무 목표 및 우선순위  
- 예상 리스크 및 대비책  

---

지침:
1. 전체 분량은 500~650단어 이내로 유지한다.  
2. 문장은 명사형·서술형으로 끝내며, 감정적 표현은 제외한다.  
3. 입력이 비어 있으면 아래 기본 내용을 자동으로 채운다.
4. 날짜는 월화수목금의 요일만 사용한다.

---

[기본 디폴트 예시]
- **업무 내용**: LangChain 실습 복습, 문서 분석 코드 개선, 팀 회의 참석  
- **느낀 점**: 구조화된 학습이 업무 이해에 도움됨. 반복 작업 효율 개선 필요.
```

