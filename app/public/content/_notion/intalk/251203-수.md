---
태그: []
날짜: "2025-12-03"
이름: "25.12.03 (수)"
---

# 25.12.03 (수)


# 📅 날짜: 25.12.03 (수)


## 🧩 주요 업무


- 보장분석 기준표의 보장항목(암·뇌·심장·실손·후유장해·사망 등)을 실제 보험사 표준 특약명(고액암진단비, 암진단비, 소액암진단비, 뇌혈관질환진단비, 질병수술비 등)으로 매핑하여, 보장분석 GPT에서 일관되게 사용할 수 있는 보장명 표준화 1차 데이터 정리

- 인톡 파트너스 페이지 및 외부 웹 자원에 대해 LLM이 직접 접근·로그인할 수 없음을 명확히 정의하고, 대신 화면 캡처·텍스트·PDF·JSON 기반 분석 및 구조 설계만 수행 가능하다는 기술적 범위 정리

- 보장분석 GPT의 초기 버전을 RAG 없이 챗봇 구조만으로 구성하기 위해 판단 노드(보험 관련 여부), 챗봇 노드, 검증 노드(응답 품질 점검)로 최소 노드 구성을 재정의하고, 우선 구축 대상 흐름을 단순화

- PDF 파싱 및 보험 도메인 질의 확장을 위해 직업군 분류, 보장명 인식, PDF → JSON 변환 범위, pdfplumber 기반 테이블 추출 정확도, OCR 도입 여부 등 기술 옵션을 비교 검토

- FastAPI와 Streamlit 간 연동 문제를 해결하기 위해 LangChain 모듈 경로 변경, .env 로딩 순서 수정, Windows cp949 인코딩 문제 해결 등 환경·인프라 이슈를 정리하고 서버 정상 구동 상태 확보

- LangGraph 기반 챗봇에 Summarize 노드를 추가하여 멀티턴 대화에서 “가격은?”, “그럼?” 같은 후속 질문도 이전 대화 요약을 활용해 보험 관련 질문으로 인식할 수 있도록 상태 구조 및 그래프 엣지를 개선

- PDF 분석 API에서 Pydantic 모델 반환 구조를 반영하도록 AttributeError를 수정하고, 월납입료·소득대비 비율·적정 여부·초과금액까지 포함하는 응답 스키마를 재구성했으나, Streamlit UI 표시 문제는 미해결 상태로 남김

## 🎯 목표 정리


### 장기 목표


- 표준화된 보장명·보장 기준표·페르소나 기반 추천 로직을 통합하여, 실제 보험설계사 업무에 투입 가능한 수준의 보장분석 GPT 서비스를 구축하고, 인톡 파트너스 환경에서 안정적으로 운영 가능한 형태로 고도화

- LangGraph 기반 챗봇·PDF 분석·보장 기준 매칭·설명 생성까지 하나의 파이프라인으로 연결하여, 사용자가 보험 증권만 업로드해도 구조화된 보장 진단 및 설계 가이드를 받을 수 있는 시스템 완성

### 단기 목표


- 표준 보장명 매핑 테이블과 기준표를 백엔드 분석·매칭 로직과 연결하여, 실제 PDF 분석 결과에서 각 담보가 어떤 표준 항목과 매칭되는지 일관되게 표시

- FastAPI·Streamlit·LangGraph·분석 모듈 간 데이터를 끝까지 전달하고, PDF 분석 결과가 UI에 온전히 출력되도록 디버깅을 마무리

## ⚙️ 진행 및 이슈


- 보장분석 기준표의 보장 유형/항목/보장 수준을 기준으로 실제 업계 특약명을 재정렬하여, 기준표와 보험가입내역서 사이를 연결하는 핵심 레퍼런스를 구축함

- 인톡 파트너스에 대한 LLM 접근 범위를 “직접 접속 불가, 사용자 제공 데이터 기반 분석 가능”으로 명확히 정의함으로써, 향후 요구사항 범위 설정 및 책임 구분에 활용 가능한 기준 정립

- LangChain 버전 변경으로 인한 `set_llm_cache` 경로 변경, .env 로딩 시점 문제, Windows 인코딩 문제를 각각 코드 수정과 출력 래핑으로 해결하여 FastAPI(8000), Streamlit(8501) 동시 구동 상태를 회복

- LangGraph의 ChatbotState에 `summary` 필드를 추가하고 Summarize 노드를 도입하여, 최근 10개 메시지 요약을 기반으로 Classifier가 대화 흐름 전체를 고려해 보험 관련 여부를 판단하도록 수정

- PDF 분석 API 반환 객체를 Pydantic 속성 기준으로 재처리하고, 월납입료·소득대비 비율 계산 로직을 포함한 `premium_analysis` 블록을 추가했으나, Streamlit 측에서 diagnosis·summary 출력이 보이지 않는 문제가 남아 있어 추가 로깅·단위 테스트 필요

## 🧠 느낀 점 및 개선


- 보장명 표준화, 기준표, PDF 분석, 챗봇 구조까지 연결되면서 서비스 전체 구조가 실제 서비스 수준에 근접하고 있고, 이제부터는 개별 기능 구현보다 통합 품질·사용 경험을 점검하는 단계로 넘어가야 함

- 기술적으로는 LangGraph, FastAPI, Streamlit, Pydantic, LangChain 등 구성 요소 간 인터페이스 정의를 더 엄격하게 관리해야 디버깅 비용을 줄일 수 있으며, 특히 응답 스키마와 UI 렌더링 구조를 조기에 고정하는 것이 필요함

- 개인적으로는 이제 구현 결과가 실제 사용자 서비스에 연결될 수 있는 지점까지 도달했으므로, 이후에는 기능 추가보다는 안정성·설명력·성능 최적화 비중을 높이는 방향이 적절함

## 🤝 협업 및 커뮤니케이션


- 보장분석 GPT의 초기 버전을 RAG 없이도 동작 가능한 챗봇 중심 구조로 우선 구축하고, 이후 표준 문서·약관 연동 RAG를 추가하는 단계적 접근이 현실적이라는 논의를 정리함

- 보험 도메인 질의 확장과 관련해, 직업군 분류·보장명 인식·PDF→JSON 변환 범위, pdfplumber 기반 테이블 추출 한계 및 OCR 도입 시점 등 기술적 고려사항을 공유하여, 팀 내 역할 분담 및 우선순위 설정에 참고 가능한 기준 마련

## 📚 참고 및 학습 내용


- LangGraph의 상태 그래프 설계 패턴(요약 노드 → 분류 노드 → 응답 노드)을 보험 도메인에 적용하면서, 멀티턴 대화에서 컨텍스트 유지·필터링을 어떻게 설계할지에 대한 패턴을 정리

- FastAPI·Streamlit·Windows 환경에서의 UTF-8 출력 및 타임아웃 설정, LangChain 버전 변경에 따른 모듈 경로 변경 등 운영 환경 관련 이슈를 정리하여, 향후 배포·운영 시 체크리스트로 활용 가능

## 📈 성과 및 지표


- 보장명 표준화 매핑 1차 완료로, 기준표와 실제 가입내역 간 자동 매칭 기반이 확보되었고, 추후 추가 담보 확장 시에도 동일 구조로 확장 가능

- FastAPI/Streamlit 서버가 동시에 정상 작동하고 Health check 응답까지 확인되어, 최소한 백엔드·프론트엔드 통신 경로는 확보된 상태

- 멀티턴 대화에서 후속 질문이 이전 문맥과 함께 처리될 수 있는 Summarize + Classifier 구조를 구현하여, 챗봇 품질 개선을 위한 기반 구성 완료

## 🗓️ 내일 계획


- PDF 분석 결과가 Streamlit UI에 정상적으로 렌더링되지 않는 원인을 파악하기 위해 `diagnosis_dict` 생성 단계와 프론트엔드 렌더링 루틴에 상세 로그를 추가하고, 최소 예제 데이터를 활용한 단위 테스트 수행

- 오늘 정리한 보장명 표준화 테이블을 기준으로, PDF 파싱 결과에서 각 담보를 어느 표준 항목에 매핑할지에 대한 매핑 로직을 구체화하고, analyzer 모듈과의 연동 방식을 설계

- 챗봇 그래프에 RAG 및 도구 노드를 어떻게 단계적으로 추가할지(보험료 계산, 표준 기준 조회, PDF 재요약 등) 로드맵을 간단히 정리하고, 우선 순위 도구부터 설계 방향을 도출

```json
당신은 ‘업무일지와 회고 정리 전문가’다.  
아래 사용자의 입력을 바탕으로 하루치 업무일지를 Markdown 형식으로 작성하라.  
입력이 비어 있으면 디폴트 예시 내용을 넣는다.  
결과는 실제 업무 문서에 기록 가능한 수준의 정확성·간결성을 유지하라.

---

입력 형식:
[업무 내용]
1. 업무 요약
"""
# 2025-12-03 업무 요약
1. 보장분석 기준표 → 실제 보험 보장명 매핑 작업

암·뇌·심장·실손·후유장해·사망 등 보장항목별 대표 보장명을
실제 보험사들이 사용하는 표준 특약명으로 정리.

입력 표의 “보장 유형/항목/보장 수준”을 기반으로
고액암진단비, 암진단비, 소액암진단비, 뇌혈관질환진단비, 질병수술비 등으로
업계 표기 기준에 맞게 변환.

보장분석 GPT에서 쓸 수 있는 보장명 표준화의 기초 데이터를 확보.

2. 인톡 파트너스 접근 가능성 확인

LLM이 실제 웹 접속/로그인은 할 수 없음을 명확히 정리.

대신 사용자가 제공하는 화면·텍스트·PDF·JSON 기반 분석 및
구조 설계는 가능하다는 기술적 범위 명시.

3. 보장분석 GPT 구성 관련 사전 논의

RAG 제외한 챗봇 구조에서 필요한 노드 재검토:

판단노드(보험 관련 여부 판단)

챗봇노드

검증노드(응답 품질 적절성 체크)

기본 흐름을 단순화해 우선 구축하는 방향 확인.

4. 보험 도메인 질의 확장

보험 보장명, 직업군 분류, PDF→JSON 가능 범위 논의.

PDF 파싱 방식(pdfplumber), 테이블 추출 accuracy, OCR 도입 여부 등
기술적 선택지 비교.

요약

보장명 표준화 작업 1차 완료

챗봇 기본 노드 구성 정리

PDF 파싱/보장 추출 관련 기술 검토

인톡 파트너스 접근 범위 확인
"""
2. 코드 작업
"""
# 개발 일지 - 2025-12-03

## 📌 주요 작업 내용

### 1. FastAPI 연결 문제 해결

**문제:**
- `python main.py` 실행 시 Streamlit은 시작되지만 FastAPI가 연결되지 않음
- "Stopping..." 메시지만 표시되고 API 서버 실패

**원인 분석:**
1. **langchain.globals 모듈 오류** (`backend/chatbot.py:17`)
   - `from langchain.globals import set_llm_cache`
   - LangChain 버전 변경으로 모듈 경로가 변경됨

2. **환경변수 로딩 순서 문제** (`backend/app.py`)
   - chatbot 임포트 시 OPENAI_API_KEY가 로드되지 않음
   - .env 파일이 chatbot 초기화 전에 로드되어야 함

3. **Windows 인코딩 문제**
   - cp949 인코딩으로 인해 이모지 출력 실패
   - `UnicodeEncodeError: 'cp949' codec can't encode character`

**해결 방법:**

```python
# backend/chatbot.py
from langchain_core.globals import set_llm_cache  # 수정됨

# backend/app.py
import utils.config  # .env 로드 (chatbot 임포트 전)
from utils.logger import get_logger
from chatbot import InsureChatbot

# utils/logger.py
console_handler = logging.StreamHandler(
    io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    if hasattr(sys.stdout, 'buffer') else sys.stdout
)

# main.py
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')
```

**결과:**
- ✅ FastAPI: http://localhost:8000 정상 작동
- ✅ Streamlit: http://localhost:8501 정상 작동
- ✅ Health check: `{"status":"healthy"}` 응답 확인

---

### 2. 멀티턴 대화 개선 (Summarize 노드 추가)

**문제:**
- 판단 노드가 마지막 메시지만 평가하여 대화 컨텍스트 무시
- "그럼", "가격은?", "얼마나?" 같은 후속 질문이 차단됨

**Before (이전):**
```
사용자: "암보험에 대해 알려주세요"
→ ✅ 답변 생성

사용자: "가격은?"
→ ❌ 거절 (히스토리 무시)
```

**구현 내용:**

1. **ChatbotState에 summary 필드 추가** (`backend/chatbot.py:28`)
```python
class ChatbotState(TypedDict):
    messages: Annotated[list, add_messages]
    summary: str  # 대화 히스토리 요약 (최근 10개 메시지)
    is_insurance_related: bool
    intent: str
    draft_answer: str
    final_answer: str
    validation_score: int
```

2. **Summarize 노드 추가** (`backend/chatbot.py:49-91`)
- 메시지가 3개 이상일 때만 작동
- 최근 10개 메시지만 요약
- 2-3문장으로 간결하게 요약

3. **Classifier 노드 수정** (`backend/chatbot.py:97-143`)
- 요약문이 있으면 컨텍스트 포함한 프롬프트 사용
- 대화 흐름을 고려한 판단

4. **그래프 수정**
```python
# 기존: START -> classifier
# 변경: START -> summarize -> classifier
graph_builder.add_edge(START, "summarize")
graph_builder.add_edge("summarize", "classifier")
```

**After (개선 후):**
```
사용자: "암보험에 대해 알려주세요"
→ ✅ 답변 생성

사용자: "가격은?"
→ summarize: "사용자가 암보험에 대해 질문했고..."
→ classifier: "가격은?" + 요약문 → 보험 관련 O
→ ✅ 답변 생성
```

---

### 3. Timeout 연장

**문제:**
- PDF 분석 시 60초 제한으로 타임아웃 발생
- `HTTPConnectionPool: Read timed out`

**해결:**
```python
# frontend/streamlit_app.py

# 챗봇 API 호출
timeout=600  # 10분 (기존: 30초)

# PDF 분석 API 호출
timeout=600  # 10분 (기존: 60초)
```

---

### 4. DEBUG 모드 설정 개선

**구현:**
```python
# utils/config.py
DEBUG = os.getenv("DEBUG", "1") == "1"  # 기본값: 1 (활성화)

if DEBUG:
    logger.info("디버그 모드 활성화됨")
else:
    logger.info("디버그 모드 비활성화됨")
```

**사용법:**
- 기본: 디버그 모드 활성화
- `.env` 파일에 `DEBUG=0` 추가 시 비활성화

---

### 5. PDF 분석 API 수정

**문제:**
- `analyze()` 함수가 Pydantic 모델 반환
- `app.py`에서 `.get()` 메서드로 접근 시도하여 AttributeError 발생

**원인:**
```python
# ❌ 기존 코드 (오류)
result = analyze(pdf_bytes, profile)
customer_name = result.get("customer_name", "고객")  # AttributeError!
```

**해결:**
```python
# backend/app.py

# PDF 파서 임포트 추가
from pdf_parser import parse_pdf, calculate_monthly_premium, calculate_premium_ratio

# Pydantic 속성 접근
customer_name = result.고객명
영역별_진단 = result.영역별_진단

# 월납입료 계산 추가
parsed_pdf = parse_pdf(pdf_bytes)
premium_info = calculate_monthly_premium(parsed_pdf)
premium_ratio = calculate_premium_ratio(
    monthly_premium=premium_info["총_월납입료"],
    monthly_income=profile.income,
    is_married=bool(profile.married),
)

# 응답 변환
return AnalyzeResponse(
    customer_name=result.고객명,
    premium_analysis={
        "total": premium_info["총_월납입료"],
        "ratio": premium_ratio["현재비율"],
        "status": premium_ratio["판정"],
        "적정비율": premium_ratio["적정비율"],
        "초과금액": premium_ratio["초과금액"]
    },
    diagnosis=diagnosis_dict,
    summary=result.종합진단_결과.종합의견
)
```

---

### 6. Analyzer 로깅 시도 및 Final State 구조 추론

**시도한 방법들:**
1. `logger.info(pprint.pformat(final_state))` - 출력 안 됨
2. `logger.info(f"{final_state}")` - 출력 안 됨
3. `print(f"{final_state}")` - 출력 안 됨

**원인:**
- `final_state`가 너무 길어서 로거나 콘솔에서 잘림
- 대용량 객체 (DataFrame, Pydantic 모델 등) 포함

**해결 방법:**
- 로깅 대신 코드 분석으로 구조 추론

**Final State 구조 (추론):**
```python
final_state = {
    # 입력
    "pdf_bytes": bytes(...),
    "profile": 고객프로필(age='30s', gender='M', job='office', income=1000, ...),

    # 중간 결과
    "customer_info": {
        "고객명": "유인창",
        "보험나이": 35,
        "성별": "M"
    },
    "parsed_pdf": {
        "정액요약": [...],
        "정액상세": [...],
        "실손": [...],
        "all_tables": [...]
    },
    "standard_df": pd.DataFrame(...),  # 960개 표준 기준
    "customer_coverages": {
        "암진단비(일반암)": 3000,
        "암진단비(소액암)": 500,
        "뇌출혈진단비": 1000,
        ...
    },
    "영역별_진단": [
        영역별진단(
            보장범위="암",
            필수보장_진단=[보장진단(...), ...],
            선택보장_현황=[]
        ),
        영역별진단(보장범위="뇌혈관", ...),
        영역별진단(보장범위="심장", ...),
        영역별진단(보장범위="상해", ...),
        영역별진단(보장범위="질병", ...),
    ],

    # 최종 결과
    "result": 보장분석결과(
        고객명="유인창",
        보험나이=35,
        성별="M",
        영역별_진단=[...],
        종합진단_결과=종합진단(종합의견="...")
    ),

    "grounding_scores": None  # DEBUG=1일 때만 값 있음
}
```

**분석 결과:**
- PDF 분석은 정상 작동 (로그 확인)
- `result` 객체는 올바르게 생성됨
- `app.py`의 응답 변환도 올바르게 구현됨
- UI에 표시되지 않는 이유는 아직 불명확 (추가 디버깅 필요)

---

### 7. UI 표시 문제 분석

**현재 상황:**
- ✅ PDF 파싱 완료: 537,460원 (소득대비 5.37%)
- ✅ 보장 분석 완료
- ❌ UI에 결과가 표시되지 않음

**app.py 응답 구조:**
```python
AnalyzeResponse(
    customer_name="유인창",
    profile={...},
    premium_analysis={
        "total": 537460,
        "ratio": 5.37,
        "status": "적정",
        "적정비율": 5.0,
        "초과금액": 0
    },
    diagnosis={
        "암": [
            {"name": "암진단비(일반암)", "status": "적정", "amount": 3000, ...},
            ...
        ],
        "뇌혈관": [...],
        ...
    },
    summary="전반적으로 보장 수준이 양호하나..."
)
```

**streamlit_app.py 처리 코드 (frontend/streamlit_app.py:186-235):**
```python
result = response.json()

# 1. 고객 정보 표시
st.markdown(f"### 👤 {result['customer_name']}")

# 2. 월납입료 분석
premium = result.get('premium_analysis', {})
st.metric("총 월납입료", f"{premium.get('total', 0):,}원")
st.metric("소득 대비", f"{premium.get('ratio', 0):.1f}%")

# 3. 보장 진단
diagnosis = result.get('diagnosis', {})
for area, items in diagnosis.items():
    with st.expander(f"📌 {area}", expanded=False):
        for item in items:
            icon = "✅" if item.get('status') == "적정" else "❌"
            st.markdown(f"{icon} **{item.get('name')}**: {item.get('amount', 0):,}원")
```

**예상 문제:**
1. `diagnosis`가 비어있거나 데이터가 없음
2. 프론트엔드 렌더링 조건을 만족하지 못함
3. 에러가 발생했지만 Streamlit에서 표시되지 않음

**다음 단계:**
- [ ] `diagnosis_dict`가 실제로 채워지는지 확인 (로그 추가)
- [ ] Streamlit 에러 메시지 확인
- [ ] 간단한 테스트 데이터로 UI 렌더링 테스트

---

## 📂 수정된 파일 목록

### Backend
- `backend/app.py` - FastAPI 서버, PDF 분석 엔드포인트 수정
- `backend/chatbot.py` - 멀티턴 대화, summarize 노드 추가
- `backend/analyzer.py` - 로거 추가, final_state 출력

### Utils
- `utils/logger.py` - Windows UTF-8 인코딩 지원
- `utils/config.py` - DEBUG 모드 설정 개선

### Frontend
- `frontend/streamlit_app.py` - Timeout 10분으로 연장

### 기타
- `main.py` - Windows UTF-8 출력 설정

---

## 🎯 다음 단계

- [ ] `diagnosis_dict`가 실제로 채워지는지 확인 (로그 추가)
- [ ] Streamlit 에러 메시지 확인
- [ ] 간단한 테스트 데이터로 UI 렌더링 테스트
- [ ] UI에 PDF 분석 결과 제대로 표시되도록 수정
- [ ] 멀티턴 대화 테스트
- [ ] RAG 추가 (보험 문서 검색)
- [ ] 대화 히스토리 DB 저장

---

## 📝 작업 요약

### 완료 ✅
1. FastAPI 연결 문제 해결 (langchain 모듈, 환경변수, 인코딩)
2. 멀티턴 대화 개선 (summarize 노드 추가)
3. Timeout 10분 연장
4. DEBUG 모드 기본값 1로 설정
5. PDF 분석 API 수정 (Pydantic 모델 처리)
6. Final State 구조 추론 완료

### 진행 중 🔄
7. UI 표시 문제 디버깅 (PDF 분석은 작동하나 UI에 표시 안 됨)

### 대기 중 ⏸️
- RAG 구현
- DB 연동
- 사용자 인증

---

**작성일:** 2025-12-03
**최종 수정:** 2025-12-03 18:00
**버전:** 1.0.1
"""

[느낀 점]
1. 드디어 내 기능을 실제 서비스에 올릴 수 있을 것 같다. 무척 기대되고 빨리 하고 싶다.

---

출력 양식:

# 📅 날짜: (예: 25.11.11 (화))

## 🧩 주요 업무
- 오늘 수행한 핵심 업무를 구체적으로 요약  
- 기술적 결과, 진행 상황, 산출물 등을 명시  

## 🎯 목표 정리
### 장기 목표
- 프로젝트의 중장기적 방향 또는 최종 지향점  
### 단기 목표
- 오늘 혹은 이번 주 달성 목표  

## ⚙️ 진행 및 이슈
- 진행 단계별 구체적 내용  
- 발생한 문제와 해결 과정  
- 미해결 과제 및 후속 조치  

## 🧠 느낀 점 및 개선
- 사용자 입력 기반으로 정리된 통찰, 개선 아이디어, 학습 내용  

## 🤝 협업 및 커뮤니케이션
- 회의, 보고, 협업 이슈, 의사소통 내용 정리  
- 논의된 결정사항 및 향후 조율 방향  

## 📚 참고 및 학습 내용
- 새로 학습하거나 참고한 기술·논문·문서  
- 업무 개선에 도움이 된 개념 또는 자료  

## 📈 성과 및 지표
- 정량적 성과(예: 정확도, 속도, 효율 등)  
- 수치가 없을 경우 주요 진척도를 서술  

## 🗓️ 내일 계획
- 다음 업무 목표 및 우선순위  
- 예상 리스크 및 대비책  

---

지침:
1. 전체 분량은 500~650단어 이내로 유지한다.  
2. 문장은 명사형·서술형으로 끝내며, 감정적 표현은 제외한다.  
3. 입력이 비어 있으면 아래 기본 내용을 자동으로 채운다.
4. 날짜는 월화수목금의 요일만 사용한다.

---

[기본 디폴트 예시]
- **업무 내용**: LangChain 실습 복습, 문서 분석 코드 개선, 팀 회의 참석  
- **느낀 점**: 구조화된 학습이 업무 이해에 도움됨. 반복 작업 효율 개선 필요.
```

